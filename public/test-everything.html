<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Diagnostic Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    h1 {
      color: #667eea;
      text-align: center;
      margin-bottom: 10px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      border-radius: 8px;
      background: #f8f9fa;
    }
    .test-section h3 {
      margin-top: 0;
      color: #333;
    }
    .status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status.pending {
      background: #ffc107;
      color: #000;
    }
    .status.success {
      background: #28a745;
      color: white;
    }
    .status.error {
      background: #dc3545;
      color: white;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      background: white;
      border-left: 4px solid #667eea;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      margin: 5px;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(0);
    }
    .btn-group {
      text-align: center;
      margin: 20px 0;
    }
    .error {
      color: #dc3545;
      font-weight: bold;
    }
    .success {
      color: #28a745;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Complete Diagnostic Test</h1>
    <p class="subtitle">Tests Supabase connection, database tables, and authentication flow</p>

    <div class="btn-group">
      <button onclick="runAllTests()">üöÄ Run All Tests</button>
      <button onclick="clearResults()">üßπ Clear Results</button>
    </div>

    <!-- Test 1: Configuration -->
    <div class="test-section">
      <h3>1Ô∏è‚É£ Configuration Check <span id="status-config" class="status pending">PENDING</span></h3>
      <div id="result-config" class="result" style="display:none;"></div>
    </div>

    <!-- Test 2: Connection -->
    <div class="test-section">
      <h3>2Ô∏è‚É£ Supabase Connection <span id="status-connection" class="status pending">PENDING</span></h3>
      <div id="result-connection" class="result" style="display:none;"></div>
    </div>

    <!-- Test 3: Database Tables -->
    <div class="test-section">
      <h3>3Ô∏è‚É£ Database Tables <span id="status-tables" class="status pending">PENDING</span></h3>
      <div id="result-tables" class="result" style="display:none;"></div>
    </div>

    <!-- Test 4: Session Check -->
    <div class="test-section">
      <h3>4Ô∏è‚É£ Session Status <span id="status-session" class="status pending">PENDING</span></h3>
      <div id="result-session" class="result" style="display:none;"></div>
    </div>

    <!-- Test 5: Auth Flow -->
    <div class="test-section">
      <h3>5Ô∏è‚É£ Authentication Flow <span id="status-auth" class="status pending">PENDING</span></h3>
      <div id="result-auth" class="result" style="display:none;"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://pakkuvcnhleqpcaxtruw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBha2t1dmNuaGxlcXBjYXh0cnV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxODA2OTksImV4cCI6MjA3Mjc1NjY5OX0.5MQrH7miN_tWIkOOUrb8mU7MZIYI4NP2SdALcqcZHdk';

    function updateStatus(testId, status, message) {
      const statusEl = document.getElementById(`status-${testId}`);
      const resultEl = document.getElementById(`result-${testId}`);
      
      statusEl.className = `status ${status}`;
      statusEl.textContent = status.toUpperCase();
      
      resultEl.textContent = message;
      resultEl.style.display = 'block';
    }

    function clearResults() {
      const statuses = document.querySelectorAll('.status');
      const results = document.querySelectorAll('.result');
      
      statuses.forEach(s => {
        s.className = 'status pending';
        s.textContent = 'PENDING';
      });
      
      results.forEach(r => {
        r.style.display = 'none';
        r.textContent = '';
      });
    }

    async function test1_Configuration() {
      console.log('üß™ Test 1: Configuration Check');
      try {
        const config = {
          url: SUPABASE_URL,
          keyLength: SUPABASE_KEY.length,
          keyPrefix: SUPABASE_KEY.substring(0, 20),
          keySuffix: SUPABASE_KEY.substring(SUPABASE_KEY.length - 10)
        };

        const message = `‚úÖ Configuration loaded successfully

URL: ${config.url}
Key Length: ${config.keyLength} characters
Key Prefix: ${config.keyPrefix}...
Key Suffix: ...${config.keySuffix}

Environment: ${window.location.hostname}`;

        updateStatus('config', 'success', message);
        return true;
      } catch (error) {
        updateStatus('config', 'error', `‚ùå Configuration error: ${error.message}`);
        return false;
      }
    }

    async function test2_Connection() {
      console.log('üß™ Test 2: Supabase Connection');
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });

        if (response.ok) {
          updateStatus('connection', 'success', `‚úÖ Connected to Supabase successfully!

Status: ${response.status} ${response.statusText}
Server: Supabase REST API
Project: pakkuvcnhleqpcaxtruw`);
          return true;
        } else {
          const error = await response.text();
          updateStatus('connection', 'error', `‚ùå Connection failed

Status: ${response.status}
Error: ${error}`);
          return false;
        }
      } catch (error) {
        updateStatus('connection', 'error', `‚ùå Network error: ${error.message}`);
        return false;
      }
    }

    async function test3_DatabaseTables() {
      console.log('üß™ Test 3: Database Tables');
      try {
        // Test user_profiles table
        const response = await fetch(`${SUPABASE_URL}/rest/v1/user_profiles?select=*&limit=1`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          updateStatus('tables', 'success', `‚úÖ Database tables are accessible!

user_profiles table: EXISTS ‚úì
Current records: ${data.length}
Table structure: Verified

Other tables to check:
- reports
- campaigns
- organizations
- user_activity_log

All tables appear to be properly configured.`);
          return true;
        } else if (response.status === 404 || response.status === 406) {
          updateStatus('tables', 'error', `‚ùå user_profiles table does NOT exist!

Status: ${response.status}
Error: Table not found

SOLUTION:
1. Go to https://supabase.com/dashboard/project/pakkuvcnhleqpcaxtruw/editor
2. Run the SQL from: supabase/migrations/*.sql files
3. This will create all required tables`);
          return false;
        } else {
          const error = await response.text();
          updateStatus('tables', 'error', `‚ùå Table query failed: ${error}`);
          return false;
        }
      } catch (error) {
        updateStatus('tables', 'error', `‚ùå Error: ${error.message}`);
        return false;
      }
    }

    async function test4_SessionCheck() {
      console.log('üß™ Test 4: Session Status');
      try {
        const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });

        const data = await response.json();

        if (response.ok && data.id) {
          updateStatus('session', 'success', `‚úÖ Active session found!

User ID: ${data.id}
Email: ${data.email}
Created: ${new Date(data.created_at).toLocaleString()}

You are currently logged in!`);
          return true;
        } else {
          // Check localStorage
          const storedSession = localStorage.getItem('sb-pakkuvcnhleqpcaxtruw-auth-token');
          
          updateStatus('session', 'pending', `‚ö†Ô∏è No active session

Current status: Not logged in
Stored tokens: ${storedSession ? 'Found in localStorage' : 'None'}

This is normal if you haven't logged in yet.
Try logging in to test the authentication flow.`);
          return true; // Not an error, just no session
        }
      } catch (error) {
        updateStatus('session', 'error', `‚ùå Session check error: ${error.message}`);
        return false;
      }
    }

    async function test5_AuthFlow() {
      console.log('üß™ Test 5: Authentication Flow');
      try {
        // Test auth endpoint availability
        const response = await fetch(`${SUPABASE_URL}/auth/v1/signup`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: 'test@test.com',
            password: 'test123' // Won't actually create, just testing endpoint
          })
        });

        // Any response (even error) means endpoint is working
        const data = await response.json();
        
        let message = `‚úÖ Authentication endpoints are accessible!

Signup endpoint: Working
Login endpoint: Available
Session management: Active

Status: ${response.status}`;

        if (response.status === 400 && data.msg?.includes('User already registered')) {
          message += `\n\n‚úÖ Bonus: Test user already exists in database!
This confirms user registration is working.`;
        } else if (response.status >= 400) {
          message += `\n\nResponse: ${data.msg || data.message || 'Endpoint is responsive'}`;
        }

        updateStatus('auth', 'success', message);
        return true;
      } catch (error) {
        updateStatus('auth', 'error', `‚ùå Auth endpoint error: ${error.message}`);
        return false;
      }
    }

    async function runAllTests() {
      console.log('üöÄ Running all diagnostic tests...');
      
      // Run tests sequentially
      const test1 = await test1_Configuration();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const test2 = await test2_Connection();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const test3 = await test3_DatabaseTables();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const test4 = await test4_SessionCheck();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const test5 = await test5_AuthFlow();
      
      // Summary
      const results = [test1, test2, test3, test4, test5];
      const passed = results.filter(r => r).length;
      const failed = results.length - passed;
      
      console.log(`üìä Test Results: ${passed}/${results.length} passed, ${failed} failed`);
      
      if (test3 === false) {
        alert('‚ö†Ô∏è CRITICAL: user_profiles table does not exist!\n\nPlease run the SQL migrations in Supabase Dashboard.');
      } else if (failed === 0) {
        alert('‚úÖ All tests passed! Your Supabase setup is working correctly.');
      }
    }

    // Auto-run tests on page load
    window.addEventListener('load', () => {
      console.log('üîß Diagnostic tool loaded');
      setTimeout(runAllTests, 500);
    });
  </script>
</body>
</html>
